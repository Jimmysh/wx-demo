<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="//res2.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script src="//cdn.bootcdn.net/ajax/libs/vConsole/3.9.1/vconsole.min.js"></script>
  </head>
  <body>
    <h1>测试1</h1>
    <button onclick="takePhoto()">拍照</button>
    <h2>base64照片</h2>
    <img id="img1" />
    <h2>选择的照片</h2>
    <img id="img2" />
    <script>
      const img1 = document.querySelector("#img1");
      const img2 = document.querySelector("#img2");
      const server = "http://www.malianghang.cn/wechat-api/config";
      function wechatJsSuccess(conf) {
        wx.config({
          debug: false,
          appId: "wx763742d9bf7b1b13",
          timestamp: conf.timestamp,
          nonceStr: conf.nonceStr,
          signature: conf.signature,
          jsApiList: [
            "checkJsApi",
            "startRecord",
            "stopRecord",
            "onRecordEnd",
            "playVoice",
            "pauseVoice",
            "chooseImage",
            "stopVoice",
            "uploadVoice",
            "downloadVoice",
            "onMenuShareTimeline",
            "onMenuShareAppMessage",
            "onMenuShareQQ",
            "onMenuShareWeibo",
          ],
        });
      }

      wx.ready(function () {
        alert("ready");
      });

      fetch(server + `?url=${encodeURIComponent(window.location.href)}`)
        .then((d) => d.json())
        .then((d) => {
          console.log(d);
          wechatJsSuccess(d);
        });

      function takePhoto() {
        wx.chooseImage({
          count: 1, // 默认9
          sizeType: ["original", "compressed"], // 可以指定是原图还是压缩图，默认二者都有
          sourceType: ["camera"], // 可以指定来源是相册还是相机，默认二者都有
          success: function (res) {
            console.log("success", res);
            const localId = res.localIds[0];
            this.wx.getLocalImgData({
              localId,
              success: (res) => {
                console.log("getLocalImgData", res);
              },
            });
            const images = res.tempFilePaths || res.localIds;
            const img = images[0];
            img2.src = img;
            const image = new Image();
            image.src = img;
            image.onload = () => {
              const canvas = document.createElement("canvas");
              const canvasContext = canvas.getContext("2d");
              canvas.width = 600;
              canvas.height = 800;
              canvasContext.drawImage(
                image,
                (image.naturalWidth - 600) / 2,
                (image.naturalHeight - 800) / 2,
                600,
                800,
                0,
                0,
                canvas.width,
                canvas.height
              );
              img2.src = canvas.toDataURL("image/jpeg", 0.85);
            };
          },
          error: function (err) {
            console.log("err", err);
          },
        });
      }
      var vConsole = new window.VConsole();
    </script>
  </body>
</html>
